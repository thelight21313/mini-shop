<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Магазин</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding-top: 85px;
    }

    /* HEADER */
    .navbar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 0 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 85px;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.25);
      z-index: 1000;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .navbar:hover {
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
      height: 90px;
    }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 35px;
    }

    .nav-links a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      font-size: 16px;
      padding: 10px 0;
      position: relative;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      opacity: 0.9;
    }

    .nav-links a:hover {
      opacity: 1;
      transform: translateY(-2px);
    }

    .nav-links a::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 3px;
      background: white;
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .nav-links a:hover::after {
      width: 100%;
    }

    .user-section {
      display: flex;
      align-items: center;
      gap: 25px;
    }

    .welcome-text {
      font-size: 15px;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 400;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .profile-link, .logout-link {
      padding: 12px 28px;
      border-radius: 12px;
      text-decoration: none;
      font-weight: bold;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }

    .profile-link {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
    }

    .profile-link:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .logout-link {
      background: white;
      color: #667eea;
      border: 2px solid white;
    }

    .logout-link:hover {
      background: #f8f9fa;
      color: #764ba2;
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }

    /* Логотип */
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-right: 40px;
    }

    .logo-icon {
      background: white;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #667eea;
      font-size: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .logo-text {
      color: white;
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    /* Иконки */
    .fas, .far {
      font-size: 16px;
    }

    /* Счётчик корзины */
    .cart-count {
      background: #ff4757;
      color: white;
      font-size: 12px;
      font-weight: bold;
      min-width: 20px;
      height: 20px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      top: -5px;
      right: -5px;
      padding: 0 6px;
      transition: all 0.3s ease;
      transform-origin: center;
    }

    /* Анимация при обновлении */
    .cart-count.updated {
      animation: pulse 0.5s ease;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }

    /* Скрываем если 0 */
    .cart-count[data-count="0"] {
      display: none !important;
    }

    /* МЕНЮ КАТЕГОРИЙ */
    .categories-menu {
      position: relative;
      display: inline-block;
    }

    .categories-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      min-width: 220px;
      border-radius: 12px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      z-index: 1000;
      padding: 10px 0;
      margin-top: 10px;
    }

    .categories-menu:hover .categories-dropdown {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .categories-dropdown::before {
      content: '';
      position: absolute;
      top: -8px;
      left: 30px;
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 8px solid white;
    }

    .category-item {
      position: relative;
    }

    .category-link {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      color: #333;
      text-decoration: none;
      transition: all 0.2s ease;
      border-bottom: 1px solid #f5f5f5;
    }

    .category-link:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding-left: 25px;
    }

    .category-link:last-child {
      border-bottom: none;
    }

    .category-link i {
      font-size: 14px;
      transition: transform 0.2s ease;
    }

    .category-link:hover i {
      transform: translateX(3px);
    }

    /* Подкатегории */
    .subcategories {
      position: absolute;
      left: 100%;
      top: 0;
      background: white;
      min-width: 200px;
      border-radius: 12px;
      box-shadow: 15px 0 40px rgba(0, 0, 0, 0.15);
      opacity: 0;
      visibility: hidden;
      transform: translateX(-10px);
      transition: all 0.3s ease;
      z-index: 1001;
      padding: 10px 0;
    }

    .category-item:hover .subcategories {
      opacity: 1;
      visibility: visible;
      transform: translateX(0);
    }

    .subcategory-link {
      display: block;
      padding: 10px 20px;
      color: #333;
      text-decoration: none;
      transition: all 0.2s ease;
      border-bottom: 1px solid #f5f5f5;
    }

    .subcategory-link:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding-left: 25px;
    }

    .subcategory-link:last-child {
      border-bottom: none;
    }

    /* Кнопка категорий */
    .categories-btn {
      color: white;
      text-decoration: none;
      font-weight: 500;
      font-size: 16px;
      padding: 10px 0;
      position: relative;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      opacity: 0.9;
      cursor: pointer;
      background: none;
      border: none;
    }

    .categories-btn:hover {
      opacity: 1;
      transform: translateY(-2px);
    }

    .categories-btn::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 3px;
      background: white;
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .categories-btn:hover::after {
      width: 100%;
    }

    /* Адаптивность */
    @media (max-width: 768px) {
      .navbar {
        padding: 0 20px;
        height: 75px;
      }

      .logo-text {
        display: none;
      }

      .nav-links {
        gap: 15px;
      }

      .user-section {
        gap: 15px;
      }

      .welcome-text {
        display: none;
      }

      .nav-links a {
        font-size: 14px;
      }

      .profile-link, .logout-link {
        padding: 10px 15px;
        font-size: 14px;
      }

      .categories-dropdown {
        min-width: 180px;
      }

      .subcategories {
        position: static;
        opacity: 1;
        visibility: visible;
        transform: none;
        box-shadow: none;
        background: #f8f9fa;
        margin-left: 20px;
        display: none;
      }

      .category-item:hover .subcategories {
        display: block;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <nav class="navbar">
    <div class="logo">
      <div class="logo-icon">
        <i class="fas fa-store"></i>
      </div>
      <span class="logo-text">MarketPlace</span>
    </div>

    <div class="nav-links">
      <a href="{%url 'home'%}">
        <i class="fas fa-home"></i>
        Главная
      </a>

      <!-- Меню категорий -->
      <div class="categories-menu">
        <button class="categories-btn">
          <i class="fas fa-list"></i>
          Категории
        </button>
        <div class="categories-dropdown" id="categoriesDropdown">
          <!-- Категории будут загружены динамически -->
          <div class="category-item">
            <a href="#" class="category-link" data-category="electronics">
              Электроника
              <i class="fas fa-chevron-right"></i>
            </a>
            <div class="subcategories">
              <a href="#" class="subcategory-link" data-category="smartphones">Смартфоны</a>
              <a href="#" class="subcategory-link" data-category="laptops">Ноутбуки</a>
              <a href="#" class="subcategory-link" data-category="headphones">Наушники</a>
            </div>
          </div>

          <div class="category-item">
            <a href="#" class="category-link" data-category="clothing">
              Одежда
              <i class="fas fa-chevron-right"></i>
            </a>
            <div class="subcategories">
              <a href="#" class="subcategory-link" data-category="men_clothing">Мужская</a>
              <a href="#" class="subcategory-link" data-category="women_clothing">Женская</a>
              <a href="#" class="subcategory-link" data-category="kids_clothing">Детская</a>
            </div>
          </div>

          <div class="category-item">
            <a href="#" class="category-link" data-category="books">
              Книги
              <i class="fas fa-chevron-right"></i>
            </a>
            <div class="subcategories">
              <a href="#" class="subcategory-link" data-category="fiction">Художественная</a>
              <a href="#" class="subcategory-link" data-category="education">Образование</a>
              <a href="#" class="subcategory-link" data-category="children_books">Детские</a>
            </div>
          </div>

          <div class="category-item">
            <a href="#" class="category-link" data-category="home_garden">
              Дом и Сад
              <i class="fas fa-chevron-right"></i>
            </a>
            <div class="subcategories">
              <a href="#" class="subcategory-link" data-category="furniture">Мебель</a>
              <a href="#" class="subcategory-link" data-category="kitchen">Кухня</a>
              <a href="#" class="subcategory-link" data-category="garden">Сад</a>
            </div>
          </div>
        </div>
      </div>

      <a href="{%url 'about'%}">
        <i class="fas fa-info-circle"></i>
        О нас
      </a>
      <a href="{%url 'cart'%}" style="position: relative;">
        <i class="fas fa-shopping-cart"></i>
        Корзина
        <!-- Счетчик с начальным значением из Django context -->
        <span class="cart-count"
              id="cartCounter"
              data-count="{{ cart_count|default:0 }}"
              style="{% if cart_count == 0 %}display: none;{% endif %}">
          {{ cart_count|default:0 }}
        </span>
      </a>
    </div>

    <div class="user-section">
      <span class="welcome-text">Добро пожаловать!</span>
      <a class="profile-link" href="{% url 'profile'%}">
        <i class="fas fa-user"></i>
        Профиль
      </a>
      <a class="logout-link" href="{% url 'exit'%}">
        <i class="fas fa-sign-out-alt"></i>
        Выйти
      </a>
    </div>
  </nav>

  <script>
    // Глобальная система обновления счетчика корзины
    class CartCounterManager {
      constructor() {
        this.counterElement = document.getElementById('cartCounter');
        this.initialize();
      }

      initialize() {
        // Начальное значение из Django шаблона
        if (this.counterElement) {
          const initialCount = this.counterElement.getAttribute('data-count') || '0';
          this.updateDisplay(parseInt(initialCount));
        }

        // Слушаем глобальные события
        this.setupEventListeners();
      }

      setupEventListeners() {
        // Слушаем кастомные события
        document.addEventListener('cartCountUpdated', (event) => {
          if (event.detail && event.detail.count !== undefined) {
            this.update(event.detail.count);
          }
        });

        // Также можно обновлять через прямой вызов window.updateCartCounter
        window.updateCartCounter = (count) => {
          this.update(count);
        };
      }

      update(count) {
        if (this.counterElement) {
          // Обновляем данные
          this.counterElement.setAttribute('data-count', count);
          this.updateDisplay(count);
        }
      }

      updateDisplay(count) {
        if (!this.counterElement) return;

        // Обновляем текст
        this.counterElement.textContent = count;

        // Показываем/скрываем
        if (count === 0) {
          this.counterElement.style.display = 'none';
        } else {
          this.counterElement.style.display = 'flex';

          // Меняем цвет в зависимости от количества
          this.updateColor(count);

          // Анимация обновления
          this.counterElement.classList.add('updated');
          setTimeout(() => {
            this.counterElement.classList.remove('updated');
          }, 500);
        }
      }

      updateColor(count) {
        let color;
        if (count >= 1) {
          color = '#4cd964'; // Зеленый
        }
        this.counterElement.style.background = color;
      }
    }

    // Система управления категориями
    class CategoryManager {
      constructor() {
        this.currentCategory = null;
        this.initializeCategoryEvents();
      }

      initializeCategoryEvents() {
        // Обработчики для всех ссылок категорий и подкатегорий
        const categoryLinks = document.querySelectorAll('.category-link, .subcategory-link');

        categoryLinks.forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const categoryName = link.getAttribute('data-category');
            this.selectCategory(categoryName, link.textContent.trim());
          });
        });
      }

      selectCategory(categoryId, categoryName) {
        this.currentCategory = categoryId;

        // Подсветка выбранной категории
        document.querySelectorAll('.category-link, .subcategory-link').forEach(link => {
          link.style.background = '';
          link.style.color = link.classList.contains('category-link') ? '#333' : '#333';
        });

        // Находим и выделяем выбранную категорию
        const selectedLink = document.querySelector(`[data-category="${categoryId}"]`);
        if (selectedLink) {
          selectedLink.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          selectedLink.style.color = 'white';
        }

        // Отправляем запрос на сервер
        this.sendCategoryChangeRequest(categoryId, categoryName);
      }

      async sendCategoryChangeRequest(categoryId, categoryName) {
        try {
          const csrfToken = this.getCSRFToken();

          const response = await fetch('/api/home/', { // Замените на ваш URL
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
              action: 'change_category',
              category_id: categoryId,
              category_name: categoryName
            })
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          // Обработка ответа от сервера
          if (data.message) {
            this.showNotification(data.message);
          }

          // Обновление счетчика корзины если пришел
          if (data.cart_count !== undefined) {
            window.refreshCartCounter(data.cart_count);
          }

          // Можно обновить список товаров на странице
          this.updateProductsList(data);

        } catch (error) {
          console.error('Ошибка при смене категории:', error);
          this.showNotification('Ошибка при загрузке категории', 'error');
        }
      }

      getCSRFToken() {
        const cookieValue = document.cookie
          .split('; ')
          .find(row => row.startsWith('csrftoken='))
          ?.split('=')[1];
        return cookieValue || '';
      }

      showNotification(message, type = 'success') {
        // Создаем уведомление
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
          <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
          <span>${message}</span>
        `;

        // Стили для уведомления
        notification.style.cssText = `
          position: fixed;
          top: 100px;
          right: 20px;
          background: ${type === 'success' ? '#4cd964' : '#ff4757'};
          color: white;
          padding: 15px 20px;
          border-radius: 10px;
          display: flex;
          align-items: center;
          gap: 10px;
          box-shadow: 0 5px 15px rgba(0,0,0,0.2);
          z-index: 2000;
          animation: slideIn 0.3s ease;
        `;

        document.body.appendChild(notification);

        // Удаляем уведомление через 3 секунды
        setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      updateProductsList(data) {
        // Здесь можно обновить список товаров на странице
        // В зависимости от того, как у вас организован вывод товаров

        // Например, если у вас есть контейнер с товарами:
        const productsContainer = document.getElementById('products-container');
        if (productsContainer && data.products) {
          // Обновляем товары
          // productsContainer.innerHTML = this.renderProducts(data.products);
        }

        // Или можно просто перезагрузить страницу
        // window.location.reload();
      }
    }

    // Добавляем стили для анимации уведомлений
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', () => {
      window.cartCounterManager = new CartCounterManager();
      window.categoryManager = new CategoryManager();
    });

    // Простая функция для обновления извне
    window.refreshCartCounter = function(count) {
      const event = new CustomEvent('cartCountUpdated', {
        detail: { count: count }
      });
      document.dispatchEvent(event);
    };

    // Функция для загрузки категорий с сервера
    async function loadCategoriesFromServer() {
      try {
        // Пример загрузки реальных категорий с сервера
        const response = await fetch('/api/categories/');
        const categories = await response.json();

        // Отрисовка категорий
        renderCategories(categories);
      } catch (error) {
        console.error('Ошибка загрузки категорий:', error);
      }
    }

    function renderCategories(categories) {
      const dropdown = document.getElementById('categoriesDropdown');
      if (!dropdown) return;

      let html = '';

      categories.forEach(category => {
        html += `
          <div class="category-item">
            <a href="#" class="category-link" data-category="${category.id}">
              ${category.name}
              ${category.children && category.children.length > 0 ? '<i class="fas fa-chevron-right"></i>' : ''}
            </a>
            ${category.children && category.children.length > 0 ? `
              <div class="subcategories">
                ${category.children.map(child => `
                  <a href="#" class="subcategory-link" data-category="${child.id}">
                    ${child.name}
                  </a>
                `).join('')}
              </div>
            ` : ''}
          </div>
        `;
      });

      dropdown.innerHTML = html;

      // Переинициализируем обработчики событий
      if (window.categoryManager) {
        window.categoryManager.initializeCategoryEvents();
      }
    }

    // Загружаем категории с сервера при загрузке
    // loadCategoriesFromServer();

  </script>
</body>
</html>