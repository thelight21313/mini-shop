limit_req_zone $binary_remote_addr zone=login_limit:10m rate=3r/5m;

server {
    listen 80;
    server_name nenado.duckdns.org;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name nenado.duckdns.org;

    ssl_certificate /etc/letsencrypt/live/nenado.duckdns.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/nenado.duckdns.org/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;

    location /static/ {
        alias /app/static/;
    }

    location = /login/ {
        limit_req zone=login_limit;
        limit_req_status 429;

        error_page 429 @rate_limited;

        proxy_pass http://django_app:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }

    location / {
        proxy_pass http://django_app:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }

    location @rate_limited {
        default_type text/html;
        add_header Content-Type "text/html; charset=utf-8";
        add_header Retry-After 300;

        return 429 '<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Too Many Requests</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
        h1 { color: #d63031; }
        .timer { font-size: 24px; margin: 20px; }
    </style>
</head>
<body>
    <h1>429 - Too Many Requests</h1>
    <p>Too many login attempts.</p>
    <div class="timer">Please try again in <span id="countdown">5</span> minutes</div>
    <script>
        let minutes = 5;
        const countdown = document.getElementById("countdown");
        setInterval(() => {
            minutes--;
            if (minutes <= 0) location.reload();
            countdown.textContent = minutes;
        }, 60000);
    </script>
</body>
</html>';
    }
}
